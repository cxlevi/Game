using UnityEngine;

public class PooledProjectile : MonoBehaviour
{
    [Header("–ü–æ–ª—ë—Ç")]
    public float speed = 15f;
    public float lifetime = 5f;

    [Header("–ü–æ–ø–∞–¥–∞–Ω–∏–µ")]
    [SerializeField] private float hitRadius = 1.5f; // ‚Üë —á—É—Ç—å —É–≤–µ–ª–∏—á–∏–ª–∏ —Ä–∞–¥–∏—É—Å –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏

    // üî¥ –í–ê–ñ–ù–û: —Ç–µ–ø–µ—Ä—å targetLayers –ù–ï –Ω—É–∂–µ–Ω –≤ Update, –Ω–æ –æ—Å—Ç–∞–≤–∏–º –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    [SerializeField] private LayerMask targetLayers;

    private Vector3 launchDirection; // ‚Üê –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Å—Ç—Ä–µ–ª–∞

    private void OnEnable()
    {
        CancelInvoke();
        Invoke(nameof(ReturnToPool), lifetime);
    }


    public void Launch(Vector3 position, Quaternion rotation, Vector3 direction, float speedOverride = -1f)
    {
        transform.position = position;
        transform.rotation = rotation;
        launchDirection = direction.normalized; // ‚Üê –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        speed = speedOverride > 0 ? speedOverride : speed;
    }

    void Update()
    {
        // ‚úÖ –õ–µ—Ç–∏–º –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
        transform.position += launchDirection * speed * Time.deltaTime;
    }

    private void OnTriggerEnter(Collider other)
    {
        Debug.Log($"[OnTriggerEnter] üí• –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å: {other.name}, tag: {other.tag}, layer: {LayerMask.LayerToName(other.gameObject.layer)}");

        if (other.CompareTag("Player"))
        {
            Debug.Log("üéØ –ü–æ–ø–∞–¥–∞–Ω–∏–µ –ø–æ –∏–≥—Ä–æ–∫—É!");
            ReturnToPool();
        }
        else
        {
            Debug.Log($"‚ùå –ù–µ –∏–≥—Ä–æ–∫: {other.tag}");
        }
    }

    private void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.yellow;
        Gizmos.DrawWireSphere(transform.position, hitRadius);

        // üî¶ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—ë—Ç–∞ (–æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ!)
        Gizmos.color = Color.red;
        Gizmos.DrawLine(transform.position, transform.position + launchDirection * 2f);
    }

    void ReturnToPool()
    {
        // üîí –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã–∑–æ–≤–∞ –Ω–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ
        if (this == null || gameObject == null)
            return;

        CancelInvoke();
        gameObject.SetActive(false);
    }
}
