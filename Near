using UnityEngine;

public class EnemyAI : MonoBehaviour
{
    [Header("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")]
    public float attackCooldown = 2f; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —É–¥–∞—Ä–∞–º–∏, —Å–µ–∫
    public float attackDistance = 1.5f;
    public float detectionRadius = 8f;
    public float moveSpeed = 4f;
    public float rotationSpeed = 8f;

    public Transform player;
    public Animator animator;

    private Rigidbody rb;
    private float lastAttackTime = -Mathf.Infinity; // —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–π —É–¥–∞—Ä –±—ã–ª –≤–æ–∑–º–æ–∂–µ–Ω —Å—Ä–∞–∑—É
    private bool isAttacking = false; // –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º, –∏–¥—ë—Ç –ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –∞—Ç–∞–∫–∏

    void Start()
    {
        rb = GetComponent<Rigidbody>();
        if (rb != null)
        {
            rb.isKinematic = true;
            rb.useGravity = false;
        }

        animator = animator ? animator : GetComponent<Animator>();
        player = player ? player : GameObject.FindGameObjectWithTag("Player")?.transform;
    }

    void Update()
    {
        if (player == null) return;

        float distance = Vector3.Distance(transform.position, player.position);
        bool detected = distance <= detectionRadius;

        // üîÅ –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç –ö –ö–ê–ñ–î–û–ú–£ –∫–∞–¥—Ä—É, –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∞—Ç–∞–∫–∏
        if (detected && !isAttacking) // ‚Üê ‚ö†Ô∏è –í–ê–ñ–ù–û: –ù–ï –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—Å—è –í–û –í–†–ï–ú–Ø –∞—Ç–∞–∫–∏!
        {
            Vector3 dirToPlayer = (player.position - transform.position).normalized;
            dirToPlayer.y = 0;
            transform.rotation = Quaternion.Slerp(transform.rotation, Quaternion.LookRotation(dirToPlayer), rotationSpeed * Time.deltaTime);
        }

        // ‚öîÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –≤—Ä–∞–≥ –Ω–∞—á–∞—Ç—å –∞—Ç–∞–∫—É
        if (detected && !isAttacking && distance <= attackDistance)
        {
            if (Time.time - lastAttackTime >= attackCooldown && !IsAttackPlaying())
            {
                StartAttack();
            }
        }

        // üèÉ –î–≤–∏–∂–µ–Ω–∏–µ ‚Äî –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ –∞—Ç–∞–∫—É–µ—Ç –ò –∏–≥—Ä–æ–∫ –≤–Ω–µ –∑–æ–Ω—ã –∞—Ç–∞–∫–∏
        bool shouldRun = detected && !isAttacking && distance > attackDistance;
        animator.SetFloat("Speed", shouldRun ? 1f : 0f);

        if (shouldRun)
        {
            Vector3 moveDir = transform.forward;
            moveDir.y = 0;
            transform.position += moveDir * moveSpeed * Time.deltaTime;
        }
        // üëá –Ø–≤–Ω–æ –∑–∞–∫—Ä–µ–ø–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é, –µ—Å–ª–∏ –∞—Ç–∞–∫—É–µ–º ‚Äî –Ω–∞ —Å–ª—É—á–∞–π "–¥—Ä–µ–π—Ñ–∞"
        else if (isAttacking)
        {
            // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º ‚Äî –ù–ï –¥–≤–∏–≥–∞–µ–º—Å—è, –ù–ï –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—Å—è
            // –ü–æ–∑–∏—Ü–∏—è –∏ –ø–æ–≤–æ—Ä–æ—Ç "–∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã" –Ω–∞ –≤—Ä–µ–º—è –∞—Ç–∞–∫–∏
        }
    }

    void StartAttack()
    {
        isAttacking = true;
        animator.SetTrigger("Attack");
        lastAttackTime = Time.time;
    }

    // üìå –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Animation Event –≤ –∫–æ–Ω—Ü–µ –∞–Ω–∏–º–∞—Ü–∏–∏ —É–¥–∞—Ä–∞
    public void OnAttackEnd()
    {
        isAttacking = false;
        // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º Speed ‚Äî —ç—Ç–æ –¥–µ–ª–∞–µ—Ç Update, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    }

    // üîç –ü—Ä–æ–≤–µ—Ä–∫–∞, –∏–≥—Ä–∞–µ—Ç—Å—è –ª–∏ —Å–µ–π—á–∞—Å –∞–Ω–∏–º–∞—Ü–∏—è —É–¥–∞—Ä–∞
    bool IsAttackPlaying()
    {
        if (animator == null) return false;
        var state = animator.GetCurrentAnimatorStateInfo(0);
        return state.IsName("Hook Punch"); // ‚Üê —É–∫–∞–∂–∏—Ç–µ –¢–û–ß–ù–û–ï –∏–º—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—Ç–∞–∫–∏ –≤ Animator!
    }

    void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.yellow;
        Gizmos.DrawWireSphere(transform.position, detectionRadius);
        Gizmos.color = Color.red;
        Gizmos.DrawWireSphere(transform.position, attackDistance);
    }
}
